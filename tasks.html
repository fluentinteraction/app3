<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GA4 test</title>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K45J2CVG');</script>
    <!-- End Google Tag Manager -->
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K45J2CVG"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <h1>GA4 test</h1>
    <div id="toolkit-display">
        <p>Code: <span id="generated-code"></span></p>
        <button onclick="copyCode()">Copy code</button>
        <button onclick="resetCode()">Reset code</button>
    </div>

    <table id="tasks-table">
        <thead>
            <tr>
                <th>Task</th>
                <th>Status</th>
                <th>Update status</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Task 1</td>
                <td id="task1-status">Not complete</td>
                <td>
                    <select id="task1-update">
                        <option disabled selected>Select...</option>
                    </select>
                    <button onclick="updateStatus('task1')">Update status</button>
                </td>
            </tr>
            <tr>
                <td>Task 2</td>
                <td id="task2-status">Not complete</td>
                <td>
                    <select id="task2-update">
                        <option disabled selected>Select...</option>
                    </select>
                    <button onclick="updateStatus('task2')">Update status</button>
                </td>
            </tr>
            <tr>
                <td>Task 3</td>
                <td id="task3-status">Not complete</td>
                <td>
                    <select id="task3-update">
                        <option disabled selected>Select...</option>
                    </select>
                    <button onclick="updateStatus('task3')">Update status</button>
                </td>
            </tr>
        </tbody>
    </table>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const baseId = 'appz5FTUV9lRIrVnX';
        const tableId = 'tbl6c1vtMHKAdvW0y';
        const apiKey = 'patbmGeSlLVLQyp3r.9ff9b009853c2c0a1232bda0220d640cca61257877c22b25336850c6b62775a5';
        let recordId = null;

        function loadCode() {
            const code = sessionStorage.getItem('code');
            if (code) {
                document.getElementById('generated-code').textContent = code;
                document.cookie = `user_id=${code}; path=/`; // Set the user_id cookie
                fetchRecordId(code);
            } else {
                window.location.href = 'index.html';
            }
        }

        function fetchRecordId(code) {
            axios.get(`https://api.airtable.com/v0/${baseId}/${tableId}`, {
                headers: {
                    Authorization: `Bearer ${apiKey}`
                },
                params: {
                    filterByFormula: `{ID}="${code}"`
                }
            }).then(response => {
                const records = response.data.records;
                if (records.length > 0) {
                    recordId = records[0].id;
                    console.log('Record ID:', recordId);
                    loadRecordData(records[0].fields);
                } else {
                    console.error('No record found with the given ID.');
                }
            }).catch(error => {
                console.error('Error fetching record ID:', error);
            });
        }

        function loadRecordData(fields) {
            console.log('Record Data:', fields); // Log the record data
            document.getElementById('task1-status').textContent = fields['Task 1'] || 'Not complete';
            document.getElementById('task2-status').textContent = fields['Task 2'] || 'Not complete';
            document.getElementById('task3-status').textContent = fields['Task 3'] || 'Not complete';
            updateDropdowns();
        }

        function copyCode() {
            const code = document.getElementById('generated-code').textContent;
            navigator.clipboard.writeText(code);
        }

        function resetCode() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        function updateStatus(taskId) {
            const status = document.getElementById(`${taskId}-update`).value;
            document.getElementById(`${taskId}-status`).textContent = status;
            const code = sessionStorage.getItem('code');
            const size = sessionStorage.getItem('businessSize');
            updateAirtableRecord(code, size);
            updateDropdowns();

            // Push the update status event to the data layer
            window.dataLayer.push({
                'event': 'update_status',
                'task_id': taskId,
                'status': status,
                'user_id': code
            });
            console.log('GA4 event sent: update_status', {
                'task_id': taskId,
                'status': status,
                'user_id': code
            }); // Log the event
        }

        function updateDropdowns() {
            const tasks = ['task1', 'task2', 'task3'];
            tasks.forEach(task => {
                const status = document.getElementById(`${task}-status`).textContent;
                const dropdown = document.getElementById(`${task}-update`);
                dropdown.innerHTML = `<option disabled selected>Select...</option>`;
                if (status === 'Not complete') {
                    dropdown.innerHTML += `<option value="Complete">Complete</option><option value="Skipped">Skipped</option>`;
                } else if (status === 'Complete') {
                    dropdown.innerHTML += `<option value="Not complete">Not complete</option><option value="Skipped">Skipped</option>`;
                } else if (status === 'Skipped') {
                    dropdown.innerHTML += `<option value="Not complete">Not complete</option><option value="Complete">Complete</option>`;
                }
            });
        }

        function updateAirtableRecord(code, size) {
            if (recordId) {
                const data = {
                    fields: {
                        ID: code,
                        Size: size,
                        'Task 1': document.getElementById('task1-status').textContent,
                        'Task 2': document.getElementById('task2-status').textContent,
                        'Task 3': document.getElementById('task3-status').textContent
                    }
                };

                console.log('Data being sent to Airtable:', data); // Log the data being sent

                axios.patch(`https://api.airtable.com/v0/${baseId}/${tableId}/${recordId}`, data, {
                    headers: {
                        Authorization: `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                }).then(response => {
                    console.log('Data updated in Airtable:', response.data);
                }).catch(error => {
                    console.error('Error updating Airtable:', error);
                    console.log('Error details:', error.response ? error.response.data : error.message);
                });
            } else {
                console.error('Record ID not found. Cannot update record.');
            }
        }

        window.onload = loadCode;
    </script>
</body>
</html>
